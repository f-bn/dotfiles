#!/usr/bin/env bash
set -euo pipefail

CONTAINER=""
PORT_MAPPING=""
SOCAT_EXTRA_OPTS=()

usage() {
  cat << EOF
Usage: dfwd CONTAINER PORT-MAPPING

Forward a port dynamically from host to a Docker container (much like 'kubectl port-forward' but locally).

Arguments:
  CONTAINER       Docker container name
  PORT-MAPPING    Port mapping in the following formats:
                  - SRC_PORT:DST_PORT -> explicit port mapping
                  - :DST_PORT -> only specify the container port, listen on a random port locally

Options:
  -d, --debug     Enable debug logging (socat 'd3' debug mode)
  -h, --help      Display this help message

Examples:
  dfwd c1 8080:80
  dfwd c1 :80

EOF
}

find_random_available_port() {
  local port

  while true; do
    port=$(shuf -i 49152-65535 -n 1)
    if ! ss -tln | grep -q ":${port} "; then
      echo "$port"; return
    fi
  done
}

while [[ $# -gt 0 ]]; do
  case $1 in
    -d|--debug)
      SOCAT_EXTRA_OPTS+=("-d3"); shift ;;
    -h|--help) 
      usage ; exit 0 ;;
    -*)
      echo -e "Error: unknown option: $1\n"; usage ; exit 1 ;;
    *)
      if [[ -z "${CONTAINER}" ]]; then
        CONTAINER="$1"
      elif [[ -z "${PORT_MAPPING}" ]]; then
        PORT_MAPPING="$1"
      else
        echo -e "Error: too many arguments\n"; usage ; exit 1
      fi
      shift
      ;;
  esac
done

if [[ -z "${CONTAINER}" || -z "${PORT_MAPPING}" ]]; then
  echo -e "Error: CONTAINER and PORT-MAPPING are required\n"; usage; exit 1
fi

CONTAINER_IP="$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' "${CONTAINER}")"
if [[ "${PORT_MAPPING}" =~ ^[0-9]+:[0-9]+$ ]]; then
  SRC_PORT=$(awk -F: '{print $1}' <<< "${PORT_MAPPING}")
  DST_PORT=$(awk -F: '{print $2}' <<< "${PORT_MAPPING}")
elif [[ "${PORT_MAPPING}" =~ ^:[0-9]+$ ]]; then
  SRC_PORT="$(find_random_available_port)"
  DST_PORT=$(awk -F: '{print $2}' <<< "${PORT_MAPPING}")
else
  echo -e "Error: PORT-MAPPING must be in format 'SRC_PORT:DST_PORT' or ':DST_PORT' (e.g. 8080:80 or :80)\n"; usage; exit 1
fi

echo -e "Forwarding from 127.0.0.1:${SRC_PORT} -> ${CONTAINER}:${DST_PORT}\n"
exec socat "${SOCAT_EXTRA_OPTS[@]}" TCP-LISTEN:"${SRC_PORT}",bind=127.0.0.1,reuseaddr,fork,nodelay TCP:"${CONTAINER_IP}":"${DST_PORT}"