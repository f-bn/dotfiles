#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat << EOF
Usage: syd [OPTIONS] IMAGE

Launch a system container with Docker using systemd-compatible configuration.

Arguments:
  IMAGE     Docker image to run (must always be in last position).

Options:
  Any Docker run options can be passed and will be added to the default configuration.

Examples:
  syd ghcr.io/f-bn/ubuntu:24.04-init
  syd --name my-container --net=my-network ghcr.io/f-bn/ubuntu:24.04-init

EOF
  exit 0
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
elif [[ $# -eq 0 ]]; then
  usage
fi

RUN_FLAGS=(
  --detach
  --tty
  --env=container="docker"
  --stop-signal=SIGRTMIN+3
  --cgroupns=host
  --volume=/sys/fs/cgroup:/sys/fs/cgroup:rw
  --tmpfs=/run
  --tmpfs=/run/lock
  --tmpfs=/tmp
  --tmpfs=/var/lib/journal
)

echo "Launching system container with Docker"
exec docker run "${RUN_FLAGS[@]}" "$@"