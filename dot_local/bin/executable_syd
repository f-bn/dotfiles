#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat << EOF
Usage: syd [OPTIONS] IMAGE

Launch a system container with Docker using systemd-compatible configuration.

Arguments:
  IMAGE     Docker image to run (must always be in last position).

Options:
  Any Docker run options can be passed and will be added to the default configuration.

Examples:
  syd ghcr.io/f-bn/ubuntu:24.04-init
  syd --name my-container --net=my-network ghcr.io/f-bn/ubuntu:24.04-init

EOF
  exit 0
}

generate_shell_command() {
    local cid="$1"
    local cmd
    local login_path
    local bash_path

    if login_path=$(docker exec "${cid}" which login 2>/dev/null); then
        cmd="docker exec -ti -u root ${cid} ${login_path} -f root"
    elif bash_path=$(docker exec "${cid}" which bash 2>/dev/null); then
        cmd="docker exec -ti -u ${USER} ${cid} ${bash_path} -l"
    else
        cmd="docker exec -ti -u ${USER} ${cid} sh -l"
    fi
    echo "$cmd"
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
elif [[ $# -eq 0 ]]; then
  usage
fi

RUN_FLAGS=(
  --detach
  --tty
  --env=container="docker"
  --stop-signal=SIGRTMIN+3
  --cgroupns=host
  --volume=/sys/fs/cgroup:/sys/fs/cgroup:rw
  --tmpfs=/run
  --tmpfs=/run/lock
  --tmpfs=/tmp
  --tmpfs=/var/lib/journal
)

echo "Launching system container with Docker"
cid="$(docker run ${RUN_FLAGS[@]} $@ || exit 1)"
ct="$(docker inspect ${cid} | jq '.[]' || exit 1)"

echo "• ID: ${cid:0:12}"
echo "• Name: $(jq -r '.Name' <<< ${ct} | tr -d '/')"
echo "• IP Address (primary): $(jq -r '.NetworkSettings.IPAddress' <<< ${ct})"
echo

read -r -p "Do you want to open a shell in the container? (y/n) " -n 1 REPLY
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  exec $(generate_shell_command "${cid}")
fi